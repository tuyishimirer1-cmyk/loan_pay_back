<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Loan Payback System</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #4f46e5; 
            --primary-dark: #3730a3;
            --success: #10b981; 
            --danger: #ef4444; 
            --warning: #f59e0b;
            --bg: #f1f5f9; 
            --card-bg: rgba(255, 255, 255, 0.92);
            --text-main: #1e293b;
            --sidebar-bg: linear-gradient(180deg, #0f172a 0%, #1e1b4b 100%);
        }
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: url('https://images.unsplash.com/photo-1554224155-6726b3ff858f?auto=format&fit=crop&q=80&w=2000') no-repeat center center fixed;
            background-size: cover;
            margin: 0;
            display: flex;
            color: var(--text-main); 
            min-height: 100vh;
        }

        /* Sidebar UI */
        .sidebar {
            width: 280px;
            background: var(--sidebar-bg);
            color: white;
            min-height: 100vh;
            padding: 2rem;
            position: fixed;
            box-shadow: 4px 0 15px rgba(0,0,0,0.3);
            z-index: 10;
        }

        .main-content {
            margin-left: 320px;
            padding: 2rem;
            width: calc(100% - 360px);
            backdrop-filter: blur(5px);
            background: rgba(241, 245, 249, 0.6);
        }

        .container { max-width: 1100px; margin: 0 auto; }

        .card { 
            background: var(--card-bg); 
            padding: 2rem; 
            border-radius: 20px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); 
            margin-bottom: 2rem;
            border: 1px solid rgba(255,255,255,0.3);
            backdrop-filter: blur(10px);
        }

        .card-header {
            border-left: 5px solid var(--primary);
            padding-left: 1rem;
            margin-bottom: 1.5rem;
        }

        h1 { font-weight: 800; font-size: 1.5rem; margin: 0; letter-spacing: -0.025em; }
        h2 { font-weight: 700; font-size: 1.25rem; margin-top: 0; color: #0f172a; }

        .condition-item {
            font-size: 0.85rem;
            margin-bottom: 0.8rem;
            padding: 0.5rem;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            border-left: 3px solid var(--success);
        }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1.25rem; margin-bottom: 1.5rem; }
        
        .form-group { display: flex; flex-direction: column; }
        label { font-size: 0.75rem; font-weight: 700; margin-bottom: 0.5rem; color: #475569; text-transform: uppercase; }
        
        input, select, textarea { 
            padding: 0.75rem; 
            border: 2px solid #cbd5e1; 
            border-radius: 10px; 
            transition: all 0.2s;
            background: white;
        }

        input:focus { border-color: var(--primary); outline: none; background: #fff; }

        .btn { 
            padding: 0.8rem 1.5rem; 
            border: none; 
            border-radius: 10px; 
            font-weight: 700; 
            cursor: pointer; 
            transition: all 0.2s; 
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary { background: var(--primary); color: white; width: 100%; }
        .btn-primary:hover { background: var(--primary-dark); }
        
        .btn-outline { border: 2px solid #e2e8f0; background: white; color: #475569; }

        .tabs { display: flex; gap: 0.5rem; margin-bottom: 2rem; background: rgba(0,0,0,0.05); padding: 0.4rem; border-radius: 12px; }
        .tab { flex: 1; text-align: center; padding: 0.6rem; cursor: pointer; border-radius: 8px; font-weight: 600; }
        .tab.active { background: white; color: var(--primary); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        .result { margin-top: 1.5rem; padding: 1.5rem; border-radius: 12px; display: none; border-left: 6px solid transparent; }
        .result.show { display: block; animation: slideIn 0.3s ease-out; }
        .pos { background: #ecfdf5; border-color: var(--success); color: #065f46; }
        .neg { background: #fef2f2; border-color: var(--danger); color: #991b1b; }

        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 1rem; }
        th { background: #f8fafc; color: #64748b; font-weight: 700; padding: 1rem; border-bottom: 2px solid #e2e8f0; font-size: 0.7rem; }
        td { padding: 1rem; border-bottom: 1px solid #f1f5f9; }

        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<aside class="sidebar">
    <div style="margin-bottom: 2.5rem;">
        <h1 style="color: #818cf8; font-size: 1.6rem;">Loan Prediction</h1>
        <p style="opacity: 0.6; font-size: 0.75rem;">Credit Risk Decision System</p>
    </div>
    
    <nav>
        <div style="color: white; background: rgba(255,255,255,0.1); padding: 0.8rem; border-radius: 10px; margin-bottom: 2rem; font-weight: 700;">
            üìä Dashboard
        </div>

        <div style="margin-top: 2rem;">
            <p style="text-transform: uppercase; font-size: 0.7rem; letter-spacing: 1px; color: #818cf8; font-weight: 800; margin-bottom: 1rem;">Loan Conditions</p>
            <div class="condition-item">Min Credit Score: <b>650+</b></div>
            <div class="condition-item">Max DTI Ratio: <b>0.40</b></div>
            <div class="condition-item">Stable Employment Required</div>
            <div class="condition-item">Min Income: <b>$25,000/yr</b></div>
        </div>
    </nav>
</aside>

<main class="main-content">
    <div class="container">
        
        <div class="card" style="border-top: 4px solid var(--primary);">
            <div class="card-header">
                <h2>Predictive Analysis</h2>
                <p style="color: #64748b; font-size: 0.85rem; margin: 0;">Determine "Paid Back" probability using ML model</p>
            </div>
            
            <div class="tabs">
                <div class="tab active" onclick="switchTab('single')">Single Entry</div>
                <div class="tab" onclick="switchTab('batch')">Batch CSV</div>
            </div>

            <div id="single-pane">
                <form id="predictionForm">
                    <div id="dynamicFields" class="grid">
                        <p>Syncing model features...</p>
                    </div>
                    <button type="submit" class="btn btn-primary">‚ö° Run Risk Analysis</button>
                </form>
                <div id="singleResult" class="result"></div>
            </div>

            <div id="batch-pane" style="display: none;">
                <div style="border: 2px dashed #cbd5e1; padding: 2rem; text-align: center; border-radius: 16px; margin-bottom: 1.5rem; background: #fff;">
                    <label for="csvFile" style="cursor: pointer;">
                        <span style="font-size: 2rem;">üìÅ</span>
                        <p><strong>Click to upload CSV</strong></p>
                        <input type="file" id="csvFile" accept=".csv" style="display: none;" onchange="updateFileName()">
                        <span id="fileName" style="color: var(--primary); font-weight: 700;"></span>
                    </label>
                </div>
                <button onclick="runBatch()" class="btn btn-primary">Process Batch Data</button>
                <div id="batchResult"></div>
            </div>
        </div>

        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
            <section class="card" style="border-top: 4px solid var(--warning);">
                <h2>Validation Baselines</h2>
                <div style="display: grid; gap: 10px;">
                    <button onclick="testBaseline(0)" class="btn btn-outline">Check Sample 1</button>
                    <button onclick="testBaseline(1)" class="btn btn-outline">Check Sample 2</button>
                    <button onclick="testBaseline(2)" class="btn btn-outline">Check Sample 3</button>
                </div>
                <div id="baselineStatus"></div>
            </section>

            <section class="card" style="border-top: 4px solid var(--success);">
                <h2>System Audit</h2>
                <button onclick="loadHistory()" class="btn btn-outline" style="width: 100%; margin-bottom: 1rem;">üîÑ Refresh Logs</button>
                <div style="overflow-y: auto; max-height: 200px;">
                    <table id="historyTable">
                        <thead><tr><th>Time</th><th>Result</th><th>Conf.</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>
        </div>
    </div>
</main>

<script>
    const API_BASE = window.location.origin.includes('file://') ? "http://127.0.0.1:5000" : window.location.origin;

    // Mapping for user-friendly placeholders
    const placeholders = {
        "annual_income": "e.g. 55000",
        "credit_score": "e.g. 720",
        "debt_to_income_ratio": "e.g. 0.15",
        "loan_amount": "e.g. 10000",
        "interest_rate": "e.g. 8.5",
        "grade_subgrade": "e.g. 1 to 35"
    };

    const categoryMapping = {
        "gender": { 0: "Male", 1: "Female" },
        "marital_status": { 0: "Single", 1: "Married", 2: "Divorced" },
        "education_level": { 0: "High School", 1: "Bachelor", 2: "Master", 3: "PhD" },
        "employment_status": { 0: "Unemployed", 1: "Employed", 2: "Self-Employed" },
        "loan_purpose": { 1: "Debt Consolidation", 2: "Credit Card", 3: "Home Improvement", 4: "Major Purchase", 5: "Other" }
    };

    async function init() {
        try {
            const res = await fetch(`${API_BASE}/columns`);
            const data = await res.json();
            const container = document.getElementById('dynamicFields');
            container.innerHTML = data.columns.map(col => {
                const label = col.replace(/_/g, ' ').toUpperCase();
                const placeholder = placeholders[col] || "e.g. 0.00";
                
                if (categoryMapping[col]) {
                    return `<div class="form-group"><label>${label}</label>
                        <select name="${col}" required>
                            ${Object.entries(categoryMapping[col]).map(([v, t]) => `<option value="${v}">${t}</option>`).join('')}
                        </select></div>`;
                } 
                return `<div class="form-group"><label>${label}</label>
                    <input type="number" step="any" name="${col}" required placeholder="${placeholder}"></div>`;
            }).join('');
        } catch (e) { document.getElementById('dynamicFields').innerHTML = "API Connection Error"; }
    }

    document.getElementById('predictionForm').onsubmit = async (e) => {
        e.preventDefault();
        const payload = Object.fromEntries(new FormData(e.target).entries());
        Object.keys(payload).forEach(k => payload[k] = parseFloat(payload[k]));

        const res = await fetch(`${API_BASE}/predict`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        const result = await res.json();
        const display = document.getElementById('singleResult');
        display.style.display = "block";
        const isPaid = result.prediction === "Paid Back";
        display.className = `result show ${isPaid ? 'pos' : 'neg'}`;
        display.innerHTML = `<strong>Result: ${result.prediction}</strong><br>Confidence: ${(result.confidence * 100).toFixed(2)}%`;
        loadHistory();
    };

    const baselines = [
        {"id":523771,"annual_income":28114.66,"debt_to_income_ratio":0.08,"credit_score":690,"loan_amount":7133.85,"interest_rate":11.8,"gender":0,"marital_status":1,"education_level":1,"employment_status":0,"loan_purpose":1,"grade_subgrade":10},
        {"id":524810,"annual_income":122933.72,"debt_to_income_ratio":0.046,"credit_score":659,"loan_amount":7268.12,"interest_rate":7.46,"gender":1,"marital_status":2,"education_level":1,"employment_status":0,"loan_purpose":4,"grade_subgrade":19},
        {"id":100141,"annual_income":26379.82,"debt_to_income_ratio":0.14,"credit_score":710,"loan_amount":9386.27,"interest_rate":12.73,"gender":1,"marital_status":1,"education_level":0,"employment_status":0,"loan_purpose":2,"grade_subgrade":11}
    ];

    async function testBaseline(index) {
        const res = await fetch(`${API_BASE}/predict`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(baselines[index])
        });
        const result = await res.json();
        document.getElementById('baselineStatus').innerHTML = `
            <div class="result show pos" style="margin-top:10px; border-left:none; text-align:center; font-size:0.9rem;">
                Result: <b>${result.prediction}</b> | Confidence: <b>${(result.confidence * 100).toFixed(2)}%</b>
            </div>`;
    }

    async function loadHistory() {
        const res = await fetch(`${API_BASE}/history`);
        const data = await res.json();
        document.querySelector('#historyTable tbody').innerHTML = data.reverse().map(row => `
            <tr><td><small>${row.timestamp.split(' ')[1]}</small></td>
            <td><b>${row.prediction}</b></td>
            <td>${(row.confidence * 100).toFixed(1)}%</td></tr>`).join('');
    }

    function switchTab(tab) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        if(event) event.target.classList.add('active');
        document.getElementById('single-pane').style.display = tab === 'single' ? 'block' : 'none';
        document.getElementById('batch-pane').style.display = tab === 'batch' ? 'block' : 'none';
    }

    init(); loadHistory();
</script>
</body>
</html>